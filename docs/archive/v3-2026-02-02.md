# DevMan 开发规划 v3 归档

> 归档日期: 2026-02-02

## v3 变更说明

移除存储层的 Git 功能，使用纯文件式 JSON 存储。版本管理由项目自身的 Git 仓库负责。

---

## 核心架构

### 五层模型

```
Layer 5: Knowledge Service    (知识检索与复用)
Layer 4: Quality Assurance     (质量检验)
Layer 3: Progress Tracking     (进度管理)
Layer 2: Work Management       (工作执行)
Layer 1: Storage & State       (存储与状态)
```

### Phase 1: 核心数据模型 ✅

- [x] 项目初始化
- [x] 重构核心数据结构
  - [x] `Goal` - 顶层目标，带成功标准和进度
  - [x] `Project` - 工程上下文和配置
  - [x] `Phase` - 阶段划分和验收标准
  - [x] `Task` - 保留并增强（添加质量门、执行步骤）
  - [x] `WorkRecord` - 详细工作日志
  - [x] `Knowledge` - 多类型知识资产
  - [x] `QualityCheck` - 通用 + 业务质检
  - [x] `Event` - 事件系统

### Phase 2: 存储层 ✅

- [x] 扩展 `Storage` trait（支持新模型）
- [x] 实现 `JsonStorage`（文件式 JSON 存储）
- [x] 元数据版本标记（meta.json 仅含版本号和时间戳）
- [x] 查询接口（按状态筛选任务、按关联查询等）

### Phase 3: 质量保证（核心）✅

- [x] `QualityEngine` trait
- [x] 通用质检实现
  - [x] 编译检查
  - [x] 测试检查
  - [x] 格式检查
  - [x] Lint 检查
  - [x] 文档检查
- [x] 业务质检扩展机制
  - [x] `CustomCheckSpec` 设计
  - [x] 命令执行
  - [x] 输出解析（增强正则/JsonPath 解析）
- [x] 人机协作接口
  - [x] `HumanReviewSpec`
  - [x] 通知机制（Slack/Email/Webhook）
  - [x] 评审表单
- [x] 质检编排
  - [x] `QualityProfile`
  - [x] `QualityGate`
  - [x] 策略配置

### Phase 4: 知识服务 ✅

- [x] `KnowledgeService` trait
- [x] 知识检索基础
  - [x] 上下文推荐
  - [x] 标签检索（OR/AND 逻辑）
  - [x] 标签统计和建议
  - [x] 相似度匹配（基于相关性评分）
  - [x] 按类型检索
- [x] 知识模板
  - [x] 参数化模板（TemplateBuilder）
  - [x] 模板注册表（TemplateRegistry）
  -模板实例化（ [x] 支持参数替换）
  - [x] 模板验证（required/optional 参数）
- [x] 知识分类增强（无需向量库）
  - [x] 经验教训自动提取
  - [x] 代码模式识别
  - [x] 解决方案索引

### Phase 5: 进度追踪 ✅

- [x] `ProgressTracker` trait
- [x] 目标进度计算
- [x] 阶段里程碑追踪
- [x] 阻塞检测（自动识别依赖关系）
  - [x] 依赖关系阻塞检测
  - [x] 循环依赖检测（DFS算法）
  - [x] 阻塞统计（按类型/严重程度）
  - [x] 解决建议生成
- [x] AI时间预估（分钟级精度 + 复杂度分级 + 置信度）

### Phase 6: 工作管理 ✅

- [x] `WorkManager` trait
- [x] 任务创建和执行
- [x] 上下文管理
- [x] 事件记录
- [x] 工作记录生成

### Phase 7: 工具集成 ✅

- [x] `Tool` trait
- [x] 内置工具
  - [x] Cargo
  - [x] Npm
  - [x] Git
  - [x] 文件系统
- [x] 工作流编排（多步骤流程定义）
- [x] 错误处理策略（重试、回滚、降级）

### Phase 8: AI 接口 ✅ 完成

- [x] `AIInterface` trait
- [x] 交互式任务管理系统
  - [x] 任务状态机实现（10状态 + AbandonReason）
  - [x] 状态转换校验（StateTransition + 负反馈）
  - [x] 任务引导逻辑（TaskGuidanceGenerator）
  - [x] 负反馈机制（通过 StateTransition::RejectedRequiredAction）
- [x] 任务控制功能
  - [x] 暂停/恢复任务（InteractiveAI trait 已定义）
  - [x] 放弃任务（统一处理）（InteractiveAI trait 已定义）
  - [x] 需求变更处理（InteractiveAI trait 已定义）
  - [x] 任务重新分配（InteractiveAI trait 已定义）
- [x] MCP Server 实现
  - [x] MCP Tool 注册（11个内置工具）
  - [x] MCP Resources（4个内置资源）
  - [x] stdio 传输
  - [x] Unix socket 传输
- [x] CLI 更新
- [x] AI 模块测试（59个测试用例）

---

## 核心数据模型概要

### Goal（目标）

```rust
struct Goal {
    id: GoalId,
    title: String,
    success_criteria: Vec<SuccessCriterion>,
    progress: GoalProgress,
    current_phase: PhaseId,
    status: GoalStatus,
}
```

### Project（项目）

```rust
struct Project {
    id: ProjectId,
    name: String,
    config: ProjectConfig,  // 技术栈、目录结构、质检配置
    phases: Vec<Phase>,
    current_phase: PhaseId,
}
```

### QualityCheck（质检）

```rust
enum QualityCheckType {
    Generic(GenericCheckType),  // 通用（编译、测试...）
    Custom(CustomCheckSpec),    // 业务（用户扩展）
}

struct HumanReviewSpec {        // 人机协作
    reviewers: Vec<String>,
    review_guide: String,
    review_form: Vec<ReviewQuestion>,
}
```

### Knowledge（知识）

```rust
enum KnowledgeType {
    LessonLearned,
    BestPractice,
    CodePattern,
    Solution,
    Template,
    Decision,
}
```

---

## 存储层说明（v3 更新）

### JsonStorage 设计

文件式 JSON 存储，不包含 Git 集成：

```
.devman/
├── goals/           # 目标数据（JSON）
├── projects/        # 项目数据（JSON）
├── phases/          # 阶段数据（JSON）
├── tasks/           # 任务数据（JSON）
├── events/          # 事件数据（JSON）
├── knowledge/       # 知识数据（JSON）
├── quality/         # 质检数据（JSON）
├── work_records/    # 工作记录（JSON）
└── meta/            # 元数据版本标记
    ├── goals/       # 每对象一个 .meta.json
    ├── projects/
    ├── phases/
    ├── tasks/
    ├── events/
    ├── knowledge/
    ├── quality/
    └── work_records/
```

### 元数据格式

每个对象的 `meta.json` 仅包含版本信息：

```json
{
  "version": 5,
  "updated_at": "2026-01-30T12:00:00Z"
}
```

### 版本管理

- **DevMan 存储**: 仅维护元数据版本标记
- **完整快照**: 由项目自身的 Git 仓库管理
- **Rollback**: `commit()` 和 `rollback()` 方法现为 no-op（仅清空 pending 状态）

---

## 质检扩展机制

### 通用质检（内置）✅

- 编译检查
- 测试检查（支持覆盖率）
- 格式检查
- Lint 检查
- 文档检查
- 类型检查
- 安全扫描

### 业务质检（用户扩展）🔄

```rust
struct CustomCheckSpec {
    name: String,
    check_command: CommandSpec,
    validation: ValidationSpec,
    human_review: Option<HumanReviewSpec>,
}
```

### 人机协作流程

```
1. 系统运行自动质检
2. 发现需要人工判断的问题
3. 发送通知（Slack/Email/Webhook）
4. 业务人员评审（填写表单）
5. 系统记录结果，更新知识
```

---

## AI 使用流程

### 场景：AI 开始新项目

```
1. AI: "创建一个 Rust Web 框架"
2. 系统：创建 Goal + Project + Phase
3. 系统：初始化 QualityProfile
4. 系统：返回 WorkContext
```

### 场景：AI 执行任务

```
1. AI: "实现 HTTP 路由"
2. 系统：查询知识库，返回最佳实践
3. AI：创建 Task，定义 ExecutionStep
4. 系统：执行工具（cargo, git 等）
5. 系统：自动运行质检
6. 系统：记录 WorkRecord
```

---

## 优先级（按依赖顺序）

### P0 - 基础结构 ✅

1. 核心数据模型
2. 存储层（JsonStorage）
3. CLI 基础命令

### P1 - 质量保证 ⚙️

1. QualityEngine ✅
2. 通用质检实现 ✅
3. 业务质检扩展机制 🔄
4. 质检编排 ✅

### P2 - 知识服务 🔄

1. 知识存储和检索 ✅
2. 模板系统
3. 相似度匹配（可选）

### P3 - 进度与工作管理 🔄

1. ProgressTracker ✅
2. WorkManager ✅
3. 上下文管理 ✅
4. 阻塞检测
5. 时间预估

### P4 - 工具与 AI 接口 ⚙️

1. Tool trait ✅
2. 内置工具 ✅
3. AIInterface ✅
4. MCP Server 🔄
5. 工作流编排

---

## 功能实现清单

- [x] 编译检查、测试检查、格式检查、Lint 检查
- [x] 上下文推荐、标签检索、相似度匹配
- [x] 依赖关系阻塞检测、循环依赖检测
- [x] AI 时间预估（分钟级精度）
- [x] Cargo、Npm、Git、文件系统工具
- [x] 任务状态机（10状态）、任务引导、负反馈机制

---

## 文档清单

- [x] DESIGN.md - 完整设计方案
- [x] API.md - API 参考手册
- [x] QUALITY_GUIDE.md - 质检扩展指南
- [x] KNOWLEDGE.md - 知识管理指南
- [x] ARCHITECTURE.md - 架构详解
- [x] CONTRIBUTING.md - 贡献指南

---

*归档完成: 2026-02-02*
